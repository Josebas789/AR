<!DOCTYPE html>
<html>
<head>
  <title>AR Neon Navigation</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar.min.js"></script>
  <style>
    body { margin:0; overflow:hidden; font-family:sans-serif; }
    #ui-container { position:absolute; top:10px; left:0; width:100%; text-align:center; z-index:10; pointer-events:none; }
    .selector-box {
      background:rgba(255,255,255,0.9); padding:10px 20px; border-radius:20px;
      pointer-events:auto; display:inline-block; box-shadow:0 4px 6px rgba(0,0,0,0.1);
    }
    select { padding:8px; font-size:16px; border-radius:5px; }
  </style>
</head>

<body>

<div id="ui-container">
  <div class="selector-box">
    <label>游꿢 Destino: </label>
    <select id="destination" onchange="updateDestination()">
      <option value="">-- Selecciona una sala --</option>
      <option value="sala301">Sala 301</option>
      <option value="sala302">Sala 302</option>
      <option value="sala303">Sala 303</option>
      <option value="sala304">Sala 304</option>
      <option value="sala305">Sala 305</option>
      <option value="sala306">Sala 306</option>
      <option value="sala307">Sala 307</option>
      <option value="sala308">Sala 308</option>
      <option value="sala309">Sala 309</option>
      <option value="sala310">Sala 310</option>
    </select>
    <p id="instruction">Selecciona una sala y escanea un marcador.</p>
  </div>
</div>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false">
  <a-entity camera></a-entity>

  <!-- SVG neon arrows -->
  <script id="arrow-right-svg" type="text/plain">
  <svg width="512" height="256" viewBox="0 0 512 256" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <filter id="glow">
        <feGaussianBlur stdDeviation="8" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <polygon points="0,96 360,96 360,32 512,128 360,224 360,160 0,160"
             fill="#00eaff" filter="url(#glow)"/>
  </svg>
  </script>

  <script id="arrow-left-svg" type="text/plain">
  <svg width="512" height="256" viewBox="0 0 512 256" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <filter id="glow2">
        <feGaussianBlur stdDeviation="8" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <polygon points="512,96 152,96 152,32 0,128 152,224 152,160 512,160"
             fill="#00eaff" filter="url(#glow2)"/>
  </svg>
  </script>

  <script>
    function svgToBase64(id) {
      return "data:image/svg+xml;base64," + btoa(document.getElementById(id).textContent);
    }
    const ARROW_RIGHT = svgToBase64("arrow-right-svg");
    const ARROW_LEFT  = svgToBase64("arrow-left-svg");
  </script>

  <!-- Generate markers -->

  <a-marker type="pattern" url="src/patterns/pattern-pattern-301.patt" id="marker-sala301">
    <a-entity rotation="-90 0 0">
      <a-plane position="0 0.6 0"
         width="2.2"
         height="0.9"
         color="#000000"
         opacity="0.95"
         side="double">
        <a-text id="header-sala301"
          value="Sala 301\nREALIDAD AUMENTADA"
          align="center"
          width="2.4"
          color="#FFFFFF"
          position="0 0.16 0.01"></a-text>
      </a-plane>

      <a-text id="dir-sala301" value="" align="center" width="3" color="#FFFFFF" position="0 0.1 0.08"></a-text>

      <!-- Neon arrow -->
      <a-image id="arrow-img-sala301" src="" width="1.4" height="0.45"
               position="0 0.35 0.05" visible="false"></a-image>
    </a-entity>
  </a-marker>

  <a-marker type="pattern" url="src/patterns/pattern-pattern-302.patt" id="marker-sala302">
    <a-entity rotation="-90 0 0">
      <a-plane position="0 0.6 0" width="1.8" height="0.7" color="#1976D2" side="double">
        <a-text id="header-sala302" value="Sala 302\nINTRODUCCION A LA GRADUACION" align="center" width="2.2" color="#FFFFFF" position="0 0.12 0.01"></a-text>
      </a-plane>

      <a-text id="dir-sala302" value="" align="center" width="3" color="#FFFFFF" position="0 0.1 0.08"></a-text>

      <!-- Neon arrow -->
      <a-image id="arrow-img-sala302" src="" width="1.4" height="0.45"
               position="0 0.35 0.05" visible="false"></a-image>
    </a-entity>
  </a-marker>

  <a-marker type="pattern" url="src/patterns/pattern-pattern-303.patt" id="marker-sala303">
    <a-entity rotation="-90 0 0">
      <a-plane position="0 0.6 0" width="1.8" height="0.7" color="#1976D2" side="double">
        <a-text id="header-sala303" value="Sala 303\nLABORATORIO DE COMPUTACION" align="center" width="2.2" color="#FFFFFF" position="0 0.12 0.01"></a-text>
      </a-plane>

      <a-text id="dir-sala303" value="" align="center" width="3" color="#FFFFFF" position="0 0.1 0.08"></a-text>

      <!-- Neon arrow -->
      <a-image id="arrow-img-sala303" src="" width="1.4" height="0.45"
               position="0 0.35 0.05" visible="false"></a-image>
    </a-entity>
  </a-marker>

  <a-marker type="pattern" url="src/patterns/pattern-pattern-304.patt" id="marker-sala304">
    <a-entity rotation="-90 0 0">
      <a-plane position="0 0.6 0" width="1.8" height="0.7" color="#1976D2" side="double">
        <a-text id="header-sala304" value="Sala 304\nAGRONEGOCIOS DIGITALES" align="center" width="2.2" color="#FFFFFF" position="0 0.12 0.01"></a-text>
      </a-plane>

      <a-text id="dir-sala304" value="" align="center" width="3" color="#FFFFFF" position="0 0.1 0.08"></a-text>

      <!-- Neon arrow -->
      <a-image id="arrow-img-sala304" src="" width="1.4" height="0.45"
               position="0 0.35 0.05" visible="false"></a-image>
    </a-entity>
  </a-marker>

  <a-marker type="pattern" url="src/patterns/pattern-pattern-305.patt" id="marker-sala305">
    <a-entity rotation="-90 0 0">
      <a-plane position="0 0.6 0" width="1.8" height="0.7" color="#1976D2" side="double">
        <a-text id="header-sala305" value="Sala 305\nESTADISTICA APLICADA" align="center" width="2.2" color="#FFFFFF" position="0 0.12 0.01"></a-text>
      </a-plane>

      <a-text id="dir-sala305" value="" align="center" width="3" color="#FFFFFF" position="0 0.1 0.08"></a-text>

      <!-- Neon arrow -->
      <a-image id="arrow-img-sala305" src="" width="1.4" height="0.45"
               position="0 0.35 0.05" visible="false"></a-image>
    </a-entity>
  </a-marker>

  <a-marker type="pattern" url="src/patterns/pattern-pattern-306.patt" id="marker-sala306">
    <a-entity rotation="-90 0 0">
      <a-plane position="0 0.6 0" width="1.8" height="0.7" color="#1976D2" side="double">
        <a-text id="header-sala306" value="Sala 306\nQUIMICA GENERAL" align="center" width="2.2" color="#FFFFFF" position="0 0.12 0.01"></a-text>
      </a-plane>

      <a-text id="dir-sala306" value="" align="center" width="3" color="#FFFFFF" position="0 0.1 0.08"></a-text>

      <!-- Neon arrow -->
      <a-image id="arrow-img-sala306" src="" width="1.4" height="0.45"
               position="0 0.35 0.05" visible="false"></a-image>
    </a-entity>
  </a-marker>

  <a-marker type="pattern" url="src/patterns/pattern-pattern-307.patt" id="marker-sala307">
    <a-entity rotation="-90 0 0">
      <a-plane position="0 0.6 0" width="1.8" height="0.7" color="#1976D2" side="double">
        <a-text id="header-sala307" value="Sala 307\nGEOGRAFIA FISICA" align="center" width="2.2" color="#FFFFFF" position="0 0.12 0.01"></a-text>
      </a-plane>

      <a-text id="dir-sala307" value="" align="center" width="3" color="#FFFFFF" position="0 0.1 0.08"></a-text>

      <!-- Neon arrow -->
      <a-image id="arrow-img-sala307" src="" width="1.4" height="0.45"
               position="0 0.35 0.05" visible="false"></a-image>
    </a-entity>
  </a-marker>

  <a-marker type="pattern" url="src/patterns/pattern-pattern-308.patt" id="marker-sala308">
    <a-entity rotation="-90 0 0">
      <a-plane position="0 0.6 0" width="1.8" height="0.7" color="#1976D2" side="double">
        <a-text id="header-sala308" value="Sala 308\nGEOLOGIA HISTORICA" align="center" width="2.2" color="#FFFFFF" position="0 0.12 0.01"></a-text>
      </a-plane>

      <a-text id="dir-sala308" value="" align="center" width="3" color="#FFFFFF" position="0 0.1 0.08"></a-text>

      <!-- Neon arrow -->
      <a-image id="arrow-img-sala308" src="" width="1.4" height="0.45"
               position="0 0.35 0.05" visible="false"></a-image>
    </a-entity>
  </a-marker>

  <a-marker type="pattern" url="src/patterns/pattern-pattern-309.patt" id="marker-sala309">
    <a-entity rotation="-90 0 0">
      <a-plane position="0 0.6 0" width="1.8" height="0.7" color="#1976D2" side="double">
        <a-text id="header-sala309" value="Sala 309\nINTRODUCCION A LA GEOLOGIA" align="center" width="2.2" color="#FFFFFF" position="0 0.12 0.01"></a-text>
      </a-plane>

      <a-text id="dir-sala309" value="" align="center" width="3" color="#FFFFFF" position="0 0.1 0.08"></a-text>

      <!-- Neon arrow -->
      <a-image id="arrow-img-sala309" src="" width="1.4" height="0.45"
               position="0 0.35 0.05" visible="false"></a-image>
    </a-entity>
  </a-marker>

  <a-marker type="pattern" url="src/patterns/pattern-pattern-310.patt" id="marker-sala310">
    <a-entity rotation="-90 0 0">
      <a-plane position="0 0.6 0" width="1.8" height="0.7" color="#1976D2" side="double">
        <a-text id="header-sala310" value="Sala 310\nTALLER DE ETICA" align="center" width="2.2" color="#FFFFFF" position="0 0.12 0.01"></a-text>
      </a-plane>

      <a-text id="dir-sala310" value="" align="center" width="3" color="#FFFFFF" position="0 0.1 0.08"></a-text>

      <!-- Neon arrow -->
      <a-image id="arrow-img-sala310" src="" width="1.4" height="0.45"
               position="0 0.35 0.05" visible="false"></a-image>
    </a-entity>
  </a-marker>

</a-scene>

<script>
  const roomIds = [
    'sala301','sala302','sala303','sala304','sala305',
    'sala306','sala307','sala308','sala309','sala310'
  ];

  let currentDestination = null;

  function updateDestination() {
    currentDestination = document.getElementById('destination').value;

    roomIds.forEach(id => {
      document.getElementById('dir-' + id)?.setAttribute('value', '');
      document.getElementById('arrow-img-' + id)?.setAttribute('visible', false);
    });

    document.getElementById('instruction').innerText =
      currentDestination ?
        "Escanea un marcador para ver la ruta hacia " + currentDestination.replace("sala","Sala ")
        : "Selecciona una sala y escanea un marcador.";
  }

  function getRoomInfo(roomId) {
    const num = parseInt(roomId.replace('sala', ''), 10);

    // Mapa real del pasillo: lado e 칤ndice f칤sico al caminar desde la 301
    const positions = {
      301: { side: "right", index: 0 },
      302: { side: "left",  index: 1 },
      303: { side: "left",  index: 2 },
      304: { side: "right", index: 3 },
      306: { side: "right", index: 4 }, // 306 antes que 305
      305: { side: "left",  index: 5 },
      307: { side: "left",  index: 6 },
      308: { side: "right", index: 7 },
      310: { side: "right", index: 8 }, // 310 antes que 309
      309: { side: "left",  index: 9 }
    };

    return positions[num];
  }

  function normalizarTextoCartel(texto) {
  if (typeof texto !== 'string') return '';

  // 1) Normalizar y descomponer Unicode
  let s = texto.normalize("NFKD");

  // 2) Quitar diacr칤ticos
  s = s.replace(/[\u0300-\u036f]/g, "");

  // 3) Eliminar cualquier car치cter NO ASCII (A-Z 0-9 puntuaci칩n b치sica)
  s = s.replace(/[^A-Za-z0-9 .,:\-\/\n]/g, "");

  // 4) Reemplazar m칰ltiples espacios por uno solo
  s = s.replace(/\s+/g, " ");

  // 5) Poner en may칰sculas
  return s.toUpperCase().trim();
}


  function calculateDirection(currentId) {
    if (!currentDestination) return;

    const dirEl = document.getElementById('dir-' + currentId);
    const arrowImg = document.getElementById('arrow-img-' + currentId);

    if (!dirEl || !arrowImg) return;

    // Si ya est치s en la sala destino
    if (currentId === currentDestination) {
      const texto = normalizarTextoCartel("Estas en la sala destino");
      dirEl.setAttribute('value', texto);
      arrowImg.setAttribute('visible', false);
      return;
    }

    const curr = getRoomInfo(currentId);
    const dest = getRoomInfo(currentDestination);

    if (!curr || !dest) {
      const texto = normalizarTextoCartel("Destino no mapeado");
      dirEl.setAttribute('value', texto);
      arrowImg.setAttribute('visible', false);
      return;
    }

    // 쮼l destino est치 mas arriba en el pasillo?
    const goingUp = dest.index > curr.index;

    let arrow;
    if (curr.side === "left") {
      arrow = goingUp ? "->" : "<-";
    } else { // right
      arrow = goingUp ? "<-" : "->";
    }

    const texto = normalizarTextoCartel("Hacia " + currentDestination.replace("sala", "Sala "));
    dirEl.setAttribute('value', texto);

    arrowImg.setAttribute("src", arrow === "->" ? ARROW_RIGHT : ARROW_LEFT);
    arrowImg.setAttribute("visible", true);
  }

  async function actualizarCartelSala(salaId) {
    const numeroSala = salaId.replace('sala', '');

    try {
      const resp = await fetch(`http://127.0.0.1:8000/api/sala/${numeroSala}/`);
      if (!resp.ok) {
        console.error("Error al obtener horario:", resp.status);
        return;
      }

      const data = await resp.json();
      const headerEl = document.getElementById(`header-${salaId}`);
      if (!headerEl) return;

      let linea2 = "";

      if (data.asignatura) {
        const asignatura = normalizarTextoCartel(data.asignatura || '');
        const docente = normalizarTextoCartel(data.docente || '');
        const inicio = data.inicio || '';
        const termino = data.termino || '';

        linea2 = asignatura;
        if (docente) linea2 += `\n${docente}`;
        if (inicio && termino) {
          linea2 += `\n${inicio} - ${termino}`;
        }
      } else {
        linea2 = normalizarTextoCartel("Sin clases en este horario");
      }

      const textoFinal = normalizarTextoCartel(`Sala ${numeroSala}`) + `\n${linea2}`;
      console.log('TEXTO CARTEL:', textoFinal);
      headerEl.setAttribute('value', textoFinal);
    } catch (err) {
      console.error("Error en actualizarCartelSala:", err);
    }
  }

  // 游대 Vincular los eventos de los marcadores (sin depender de DOMContentLoaded)
  roomIds.forEach(id => {
    const marker = document.getElementById("marker-" + id);
    if (marker) {
      marker.addEventListener("markerFound", () => {
        calculateDirection(id);
        actualizarCartelSala(id);
      });
    }
  });
</script>

</body>
</html>
